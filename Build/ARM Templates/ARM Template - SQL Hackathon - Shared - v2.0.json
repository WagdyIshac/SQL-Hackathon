{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.1",
    "parameters": {
        "managedInstanceName": {
            "defaultValue": "sqlhackmi",
            "type": "string",
            "maxLength": 13,
            "metadata": {
                "description": "Enter name to assign to the Azure SQL Database Managed Instance. The name can contain only lowercase letters, numbers, and '-', but can't start or end with '-' or have more than 63 characters."
            }
        },
        "adminUsername": {
            "defaultValue": "DemoUser",
            "type": "string",
            "metadata": {
                "description": "Administrator user name for logging into the virtual machine and SQL MI."
            }
        },
        "adminPassword": {
            "defaultValue": "Demo@pass1234567",
            "type": "securestring",
            "minLength": 16,
            "maxLength": 128,
            "metadata": {
                "description": "The password must be between 16 and 128 characters in length and must contain at least one number, one non-alphanumeric character, and one upper or lower case letter. Default value is Password.1234567890"
            }
        },
        "vCores": {
            "type": "int",
            "defaultValue": 4,
            "allowedValues": [
                4,
                8,
                16,
                24,
                32,
                40,
                64,
                80
            ],
            "metadata": {
                "description": "Select the number of vCores for SQL Managed Instance used as the Detination."
            }
        },
        "storageSizeInGB": {
            "type": "int",
            "defaultValue": 32,
            "allowedValues": [
                32,
                64,
                96,
                128,
                160,
                192,
                224,
                256
            ],
            "metadata": {
                "description": "Select the storage size for the Managed Instance."
            }
        }
        
    },
    "variables": {
        "location": "[resourceGroup().location]",
        "uniqueManagedInstanceName": "[concat(parameters('managedInstanceName'), '-', uniqueString(resourceGroup().id))]",
        "storageAccountName": "[concat('sqlhacksa', uniqueString(resourceGroup().id))]",
        "skuName": "GP_Gen5",
        "skuEdition": "GeneralPurpose",
        "licenseType": "BasePrice",
        "hardwareFamily": "Gen5",
        "publicDataEndpointEnabled": false,
        "timezoneId": "UTC",
        "SQLlMachineSize": "Standard_DS3_v2",
        "sqlVirtualMachineName": "legacysql2008",
        "sqlNetworkSecurityGroupName": "[concat(variables('sqlVirtualMachineName'), '-nsg')]",
        "sqlNetworkInterfaceName": "[concat(variables('sqlVirtualMachineName'), '-nic')]",
        "sqlPublicIpAddressName": "[concat(variables('sqlVirtualMachineName'), '-ip')]",
        "virtualNetworkGatewayName": "[concat(resourceGroup().name, '-vnet-gateway')]",
        "vgPublicIpAddressName": "vnet-gateway-ip",
        "vgGatewayType": "Vpn",
        "vgVpnType": "RouteBased",
        "virtualNetworkName": "[concat(resourceGroup().name, '-vnet')]",
        "virtualNetworId": "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworkName'))]",
        "MIsubnetName": "ManagedInstance",
        "gatewaySubnetName": "GatewaySubnet",
        "managementSubnetName": "Management",
        "sqlCustomScriptFileName": "ARM%20Deployment%20-%20SQL%20Build%20vRC1.ps1",
        "sqlCustomScriptUri": "[concat('https://raw.githubusercontent.com/markjones-msft/SQL-Hackathon/master/Build/Powershell/', variables('sqlCustomScriptFileName'))]",
        "dmsName": "sqlhack-migrationservice",
        "dataFactoryName": "sqlhack-datafactory",
        "nodeSize": "Standard_A4_v2"
    },
    "resources": [
        {
            "name": "[variables('sqlNetworkInterfaceName')]",
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2019-04-01",
            "location": "[variables('location')]",
            "dependsOn": [
                "[concat('Microsoft.Network/publicIpAddresses/', variables('sqlPublicIpAddressName'))]",
                "[concat('Microsoft.Network/networkSecurityGroups/', variables('sqlNetworkSecurityGroupName'))]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworkName'), variables('managementSubnetName'))]"
                            },
                            "privateIPAllocationMethod": "Dynamic",
                            "publicIpAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIpAddresses', variables('sqlPublicIpAddressName'))]"
                            }
                        }
                    }
                ],
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('sqlNetworkSecurityGroupName'))]"
                }
            }
        },
        {
            "name": "[variables('sqlPublicIpAddressName')]",
            "type": "Microsoft.Network/publicIPAddresses",
            "apiVersion": "2019-04-01",
            "location": "[variables('location')]",
            "properties": {
                "publicIPAllocationMethod": "Dynamic"
            },
            "sku": {
                "name": "Basic"
            }
        },
        {
            "name": "[variables('sqlVirtualMachineName')]",
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2019-03-01",
            "location": "[variables('location')]",
            "dependsOn": [
                "[concat('Microsoft.Network/networkInterfaces/', variables('sqlNetworkInterfaceName'))]"
            ],
            "properties": {
                "hardwareProfile": {
                    "vmSize": "[variables('SQLlMachineSize')]"
                },
                "storageProfile": {
                    "osDisk": {
                        "createOption": "FromImage",
                        "name": "[concat(variables('sqlVirtualMachineName'), '_disk1_OS')]",
                        "managedDisk": {
                            "storageAccountType": "Premium_LRS"
                        }
                    },
                    "dataDisks": [
                        {
                            "lun": 1,
                            "name": "[concat(variables('sqlVirtualMachineName'), '_disk2_data')]",
                            "createOption": "Empty",
                            "caching": "ReadOnly",
                            "writeAcceleratorEnabled": false,
                            "diskSizeGB": 1023,
                            "managedDisk": {
                                "storageAccountType": "Premium_LRS"
                            },
                            "toBeDetached": false
                        }
                    ],
                    "imageReference": {
                        "publisher": "MicrosoftSQLServer",
                        "offer": "SQL2008R2SP3-WS2008R2SP1",
                        "sku": "Enterprise",
                        "version": "latest"
                    }
                },   
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('sqlNetworkInterfaceName'))]"
                        }
                    ]
                },
                "osProfile": {
                    "computerName": "[variables('sqlVirtualMachineName')]",
                    "adminUsername": "[parameters('adminUsername')]",
                    "adminPassword": "[parameters('adminPassword')]",
                    "windowsConfiguration": {
                        "enableAutomaticUpdates": true,
                        "provisionVmAgent": true
                    }
                },
                "licenseType": "Windows_Server",
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": false
                    }
                }
            },
            "resources": [
                {
                    "name": "SetupSqlVm",
                    "apiVersion": "2019-03-01",
                    "type": "extensions",
                    "location": "[variables('location')]",
                    "properties": {
                        "publisher": "Microsoft.Compute",
                        "type": "CustomScriptExtension",
                        "typeHandlerVersion": "1.9",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                            "fileUris": [
                                "[variables('sqlCustomScriptUri')]"
                            ],
                            "commandToExecute": "[concat('powershell -ExecutionPolicy Unrestricted -File ', variables('sqlCustomScriptFileName'))]"
                        }
                    },
                    "dependsOn": [
                        "[concat('Microsoft.Compute/virtualMachines/', variables('sqlVirtualMachineName'))]"
                    ],
                    "tags": {
                        "displayName": "SetupSqlVm"
                    }
                }
            ]
        },
        {
            "name": "[concat('shutdown-computevm-', variables('sqlVirtualMachineName'))]",
            "type": "Microsoft.DevTestLab/schedules",
            "apiVersion": "2017-04-26-preview",
            "location": "[variables('location')]",
            "dependsOn": [
                "[concat('Microsoft.Compute/virtualMachines/', variables('sqlVirtualMachineName'))]"
            ],
            "properties": {
                "status": "Enabled",
                "taskType": "ComputeVmShutdownTask",
                "dailyRecurrence": {
                    "time": "19:00"
                },
                "timeZoneId": "UTC",
                "targetResourceId": "[resourceId('Microsoft.Compute/virtualMachines', variables('sqlVirtualMachineName'))]",
                "notificationSettings": {
                    "status": "Disabled"
                }
            }
        },
        {
            "name": "[variables('sqlVirtualMachineName')]",
            "type": "Microsoft.SqlVirtualMachine/SqlVirtualMachines",
            "apiVersion": "2017-03-01-preview",
            "location": "[variables('location')]",
            "properties": {
                "virtualMachineResourceId": "[resourceId('Microsoft.Compute/virtualMachines', variables('sqlVirtualMachineName'))]",
                "sqlManagement": "Full",
                "SqlServerLicenseType": "AHUB",
                "AutoPatchingSettings": {
                    "Enable": true,
                    "DayOfWeek":"Sunday",
                    "MaintenanceWindowStartingHour": "2",
                    "MaintenanceWindowDuration": "60"
                },
                "KeyVaultCredentialSettings": {
                    "Enable": false,
                    "CredentialName": ""
                },
                "ServerConfigurationsManagementSettings": {
                    "SQLConnectivityUpdateSettings": {
                        "ConnectivityType": "Private",
                        "Port": "1433",
                        "SQLAuthUpdateUserName": "[parameters('adminUsername')]",
                        "SQLAuthUpdatePassword": "[parameters('adminPassword')]"
                    },
                    "SQLWorkloadTypeUpdateSettings": {
                        "SQLWorkloadType": "GENERAL"
                    },
                    "SQLStorageUpdateSettings": {
                        "DiskCount": "1",
                        "DiskConfigurationType": "NEW",
                        "StartingDeviceID": "2"
                    },
                    "AdditionalFeaturesServerConfigurations": {
                        "IsRServicesEnabled": "false"
                    }
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines',variables('sqlVirtualMachineName'))]"
            ]
        },
        {
            "name": "[variables('sqlNetworkSecurityGroupName')]",
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2019-06-01",
            "location": "[variables('location')]",
            "properties": {
                "securityRules": [
                    {
                        "name": "RDP",
                        "properties": {
                            "priority": 300,
                            "protocol": "Tcp",
                            "access": "Allow",
                            "direction": "Inbound",
                            "sourceApplicationSecurityGroups": [],
                            "destinationApplicationSecurityGroups": [],
                            "sourceAddressPrefix": "*",
                            "sourcePortRange": "*",
                            "destinationAddressPrefix": "*",
                            "destinationPortRange": "3389"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts",
            "apiVersion": "2019-04-01",
            "name": "[variables('storageAccountName')]",
            "location": "[variables('location')]",
            "sku": {
                "name": "Standard_LRS",
                "tier": "Standard"
            },
            "kind": "StorageV2",
            "properties": {
                "networkAcls": {
                    "bypass": "AzureServices",
                    "virtualNetworkRules": [],
                    "ipRules": [],
                    "defaultAction": "Allow"
                },
                "supportsHttpsTrafficOnly": true,
                "encryption": {
                    "services": {
                        "file": {
                            "enabled": true
                        },
                        "blob": {
                            "enabled": true
                        }
                    },
                    "keySource": "Microsoft.Storage"
                },
                "accessTier": "Hot"
            }
        },
        {
            "apiVersion": "2019-04-01",
            "name": "[variables('virtualNetworkGatewayName')]",
            "type": "Microsoft.Network/virtualNetworkGateways",
            "location": "[variables('location')]",
            "dependsOn": [
                "[concat('Microsoft.Network/publicIPAddresses/', variables('vgPublicIpAddressName'))]"
            ],
            "tags": {},
            "properties": {
                "gatewayType": "[variables('vgGatewayType')]",
                "ipConfigurations": [
                    {
                        "name": "default",
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworkName'), variables('gatewaySubnetName'))]"
                            },
                            "publicIpAddress": {
                                "id": "[resourceId(resourceGroup().name, 'Microsoft.Network/publicIPAddresses', variables('vgPublicIpAddressName'))]"
                            }
                        }
                    }
                ],
                "vpnType": "[variables('vgVpnType')]",
                "sku": {
                    "name": "VpnGw1",
                    "tier": "VpnGw1",
                    "capacity": 2
                }
            }
        },
        {
            "type": "Microsoft.Sql/managedInstances",
            "apiVersion": "2018-06-01-preview",
            "dependsOn": [
            ],
            "identity": {
                "type": "SystemAssigned"
            },
            "location": "[variables('location')]",
            "name": "[variables('uniqueManagedInstanceName')]",
            "sku": {
                "name": "[variables('skuName')]",
                "tier": "[variables('skuEdition')]"
            },
            "properties": {
                "administratorLogin": "[parameters('adminUsername')]",
                "administratorLoginPassword": "[parameters('adminPassword')]",
                "subnetId": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworkName'), variables('MIsubnetName'))]",
                "storageSizeInGB": "[parameters('storageSizeInGB')]",
                "vCores": "[parameters('vCores')]",
                "licenseType": "[variables('licenseType')]",
                "hardwareFamily": "[variables('hardwareFamily')]",
                "dnsZonePartner": "",
                "collation": "SQL_Latin1_General_CP1_CI_AS",
                "proxyOverride": "",
                "publicDataEndpointEnabled": "[variables('publicDataEndpointEnabled')]",
                "timezoneId": "[variables('timezoneId')]"
            }
        },
        {
            "type": "Microsoft.DataMigration/services",
            "apiVersion": "2018-04-19",
            "name": "[variables('dmsName')]",
            "location": "[variables('location')]",
            "dependsOn": [
            ],
            "sku": {
                "name": "Premium_4vCores",
                "tier": "Premium",
                "size": "4 vCores"
            },
            "properties": {
                "virtualSubnetId": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworkName'), variables('managementSubnetName'))]"
            }
        },
        {
            "apiVersion": "2019-04-01",
            "type": "Microsoft.Network/publicIPAddresses",
            "name": "[variables('vgPublicIpAddressName')]",
            "location": "[variables('location')]",
            "properties": {
                "publicIPAllocationMethod": "Dynamic"
            }
        },
        {
            "name": "[variables('dataFactoryName')]",
            "apiVersion": "2017-09-01-preview",
            "type": "Microsoft.DataFactory/factories",
            "location": "[variables('location')]",
            "properties": {},
            "resources": [
              {
                "name": "[concat(variables('dataFactoryName'), '/SPAzureSsisIR')]",
                "type": "Microsoft.DataFactory/factories/integrationRuntimes",
                "dependsOn": [
                  "[variables('dataFactoryName')]"
                ],
                "apiVersion": "2017-09-01-preview",
                "properties": {
                  "type": "Managed",
                  "LicenseType": "BasePrice",
                  "typeProperties": {
                    "computeProperties": {
                      "location": "[variables('location')]",
                      "nodeSize": "[variables('nodeSize')]",
                      
                      "numberOfNodes": 1,
                      "maxParallelExecutionsPerNode": 8,
                      "vNetProperties": {
                        "vNetId": "[variables('virtualNetworId')]",
                        "subnet": "[variables('managementSubnetName')]"
                      }
                    },
                    "ssisProperties": {
                      "catalogInfo": {
                        "catalogServerEndpoint": "[variables('uniqueManagedInstanceName')]",
                        "catalogAdminUserName": "[parameters('adminUsername')]",
                        "catalogAdminPassword": {
                          "type": "SecureString",
                          "value": "[parameters('adminPassword')]"
                        },
                        "catalogPricingTier": ""
                      }
                    }
                  }
                }
              }
            ]
        }       
    ]
}